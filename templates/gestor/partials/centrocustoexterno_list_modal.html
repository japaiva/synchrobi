<!-- Códigos ERP para Centros de Custo -->

<div class="p-3">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h6 class="mb-0">Códigos ERP - Centros de Custo</h6>
        <small class="text-muted">Total: {{ page_obj.paginator.count }} código{{ page_obj.paginator.count|pluralize }}</small>
    </div>

    {% for externo in page_obj %}
    <div class="border p-2 mb-2" id="item-{{ externo.id }}">

        <!-- Visualização -->
        <div id="view-{{ externo.id }}" {% if not externo.ativo %}style="opacity: 0.6;"{% endif %}>
            <div class="d-flex justify-content-between">
                <div>
                    <strong>{{ externo.codigo_externo }}</strong> - {{ externo.nome_externo }}
                    {% if externo.sistema_origem %}
                        <span class="badge bg-info text-dark">{{ externo.sistema_origem }}</span>
                    {% endif %}
                    {% if not externo.ativo %}
                        <span class="badge bg-secondary">Inativo</span>
                    {% else %}
                        <span class="badge bg-success">Ativo</span>
                    {% endif %}
                    <br>
                    {% if externo.codigo_responsavel %}
                        <small class="text-muted">Resp: {{ externo.codigo_responsavel.codigo }} - {{ externo.codigo_responsavel.descricao }}</small>
                    {% endif %}
                    {% if externo.codigo_beneficiado %}
                        <br><small class="text-muted">Benef: {{ externo.codigo_beneficiado.codigo }} - {{ externo.codigo_beneficiado.descricao }}</small>
                    {% endif %}
                </div>
                <div>
                    <button type="button" class="btn btn-sm btn-primary"
                            onclick="
                                document.getElementById('view-{{ externo.id }}').style.display = 'none';
                                document.getElementById('edit-{{ externo.id }}').style.display = 'block';
                            ">
                        Editar
                    </button>
                    <button type="button" class="btn btn-sm btn-danger ms-1"
                            onclick="
                                if (confirm('Excluir código {{ externo.codigo_externo }}?')) {
                                    fetch('{% url "gestor:api_centrocustoexterno_delete" externo.id %}', {
                                        method: 'POST',
                                        headers: {
                                            'X-CSRFToken': '{{ csrf_token }}',
                                            'X-Requested-With': 'XMLHttpRequest'
                                        }
                                    })
                                    .then(response => response.json())
                                    .then(data => {
                                        if (data.success) {
                                            document.getElementById('item-{{ externo.id }}').remove();
                                            alert('Excluído com sucesso!');
                                        } else {
                                            alert('Erro: ' + data.message);
                                        }
                                    })
                                    .catch(error => {
                                        alert('Erro de conexão');
                                        console.error(error);
                                    });
                                }
                            ">
                        Excluir
                    </button>
                </div>
            </div>
        </div>

        <!-- Edição -->
        <div id="edit-{{ externo.id }}" style="display: none;">
            <div class="row g-2">
                <div class="col-md-6">
                    <label class="form-label small">Código ERP *</label>
                    <input type="text" id="codigo-{{ externo.id }}" class="form-control form-control-sm"
                           value="{{ externo.codigo_externo }}" placeholder="Código ERP">
                </div>
                <div class="col-md-6">
                    <label class="form-label small">Sistema</label>
                    <input type="text" id="sistema-{{ externo.id }}" class="form-control form-control-sm"
                           value="{{ externo.sistema_origem|default:'' }}" placeholder="Sistema">
                </div>
            </div>
            <div class="row g-2 mt-1">
                <div class="col-12">
                    <label class="form-label small">Nome *</label>
                    <input type="text" id="nome-{{ externo.id }}" class="form-control form-control-sm"
                           value="{{ externo.nome_externo }}" placeholder="Nome/Descrição">
                </div>
            </div>
            <div class="row g-2 mt-1">
                <div class="col-md-6">
                    <label class="form-label small">Responsável</label>
                    <select id="responsavel-{{ externo.id }}" class="form-select form-select-sm">
                        <option value="">---------</option>
                        {% for grupo in grupos_cc %}
                        <option value="{{ grupo.codigo }}" {% if externo.codigo_responsavel and externo.codigo_responsavel.codigo == grupo.codigo %}selected{% endif %}>
                            {{ grupo.codigo }} - {{ grupo.descricao }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-6">
                    <label class="form-label small">Beneficiado</label>
                    <select id="beneficiado-{{ externo.id }}" class="form-select form-select-sm">
                        <option value="">---------</option>
                        {% for grupo in grupos_cc %}
                        <option value="{{ grupo.codigo }}" {% if externo.codigo_beneficiado and externo.codigo_beneficiado.codigo == grupo.codigo %}selected{% endif %}>
                            {{ grupo.codigo }} - {{ grupo.descricao }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            <div class="row g-2 mt-2">
                <div class="col-12">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="ativo-{{ externo.id }}" {% if externo.ativo %}checked{% endif %}>
                        <label class="form-check-label small" for="ativo-{{ externo.id }}">
                            Código ativo
                        </label>
                    </div>
                </div>
            </div>
            <div class="mt-2">
                <button type="button" class="btn btn-sm btn-success"
                        onclick="
                            const codigo = document.getElementById('codigo-{{ externo.id }}').value.trim();
                            const nome = document.getElementById('nome-{{ externo.id }}').value.trim();
                            const sistema = document.getElementById('sistema-{{ externo.id }}').value.trim();
                            const responsavel = document.getElementById('responsavel-{{ externo.id }}').value;
                            const beneficiado = document.getElementById('beneficiado-{{ externo.id }}').value;
                            const ativo = document.getElementById('ativo-{{ externo.id }}').checked;
                            const errorDiv = document.getElementById('error-{{ externo.id }}');

                            if (!codigo || !nome) {
                                errorDiv.textContent = 'Código e nome são obrigatórios';
                                errorDiv.style.display = 'block';
                                return;
                            }

                            const formData = new FormData();
                            formData.append('codigo_externo', codigo);
                            formData.append('nome_externo', nome);
                            formData.append('sistema_origem', sistema);
                            formData.append('codigo_responsavel', responsavel);
                            formData.append('codigo_beneficiado', beneficiado);
                            formData.append('centro_custo', '{{ externo.centro_custo.codigo }}');
                            if (ativo) {
                                formData.append('ativo', 'on');
                            }
                            formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');

                            fetch('{% url "gestor:centrocustoexterno_update" externo.id %}', {
                                method: 'POST',
                                headers: {
                                    'X-Requested-With': 'XMLHttpRequest'
                                },
                                body: formData
                            })
                            .then(response => response.json())
                            .then(data => {
                                if (data.success) {
                                    // Recarregar apenas o conteúdo do modal sem fechar
                                    const modalBody = document.getElementById('relatedTableModal_external_codes_cc_body');
                                    if (modalBody) {
                                        fetch('/gestor/centros-custo-externos/?centro={{ filtros.centro_codigo }}', {
                                            headers: {
                                                'X-Requested-With': 'XMLHttpRequest',
                                                'X-CSRFToken': '{{ csrf_token }}'
                                            }
                                        })
                                        .then(response => response.text())
                                        .then(html => {
                                            modalBody.innerHTML = html;
                                        });
                                    }
                                } else {
                                    errorDiv.textContent = data.message || 'Erro ao salvar';
                                    errorDiv.style.display = 'block';
                                }
                            })
                            .catch(error => {
                                console.error('Erro:', error);
                                errorDiv.textContent = 'Erro de conexão';
                                errorDiv.style.display = 'block';
                            });
                        ">
                    Salvar
                </button>
                <button type="button" class="btn btn-sm btn-secondary"
                        onclick="
                            document.getElementById('edit-{{ externo.id }}').style.display = 'none';
                            document.getElementById('view-{{ externo.id }}').style.display = 'block';
                            document.getElementById('error-{{ externo.id }}').style.display = 'none';
                        ">
                    Cancelar
                </button>
            </div>
            <div id="error-{{ externo.id }}" style="display: none; color: red; margin-top: 8px;"></div>
        </div>
    </div>
    {% empty %}
    <div class="text-center py-4 text-muted">
        <i class="fas fa-link mb-2" style="font-size: 2rem;"></i>
        <p>Nenhum código ERP cadastrado para este centro de custo</p>
    </div>
    {% endfor %}

    <!-- Paginação -->
    {% if page_obj.has_other_pages %}
    <nav aria-label="Navegação de páginas" class="mt-3">
        <ul class="pagination pagination-sm justify-content-center">
            {% if page_obj.has_previous %}
            <li class="page-item">
                <a class="page-link" href="#" onclick="event.preventDefault(); loadPage({{ page_obj.previous_page_number }})">Anterior</a>
            </li>
            {% else %}
            <li class="page-item disabled">
                <span class="page-link">Anterior</span>
            </li>
            {% endif %}

            <li class="page-item disabled">
                <span class="page-link">Página {{ page_obj.number }} de {{ page_obj.paginator.num_pages }}</span>
            </li>

            {% if page_obj.has_next %}
            <li class="page-item">
                <a class="page-link" href="#" onclick="event.preventDefault(); loadPage({{ page_obj.next_page_number }})">Próxima</a>
            </li>
            {% else %}
            <li class="page-item disabled">
                <span class="page-link">Próxima</span>
            </li>
            {% endif %}
        </ul>
    </nav>

    <script>
    function loadPage(page) {
        const modalBody = document.getElementById('relatedTableModal_external_codes_cc_body');
        if (modalBody) {
            fetch('/gestor/centros-custo-externos/?centro={{ filtros.centro_codigo }}&page=' + page, {
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': '{{ csrf_token }}'
                }
            })
            .then(response => response.text())
            .then(html => {
                modalBody.innerHTML = html;
                modalBody.scrollTop = 0;
            })
            .catch(error => {
                console.error('Erro ao carregar página:', error);
            });
        }
    }
    </script>
    {% endif %}
</div>

<!-- Botão para adicionar novo código -->
<div class="p-3 border-top">
    <button type="button" class="btn btn-success btn-sm"
            onclick="
                const form = document.getElementById('new-form');
                const isVisible = form.style.display !== 'none';
                form.style.display = isVisible ? 'none' : 'block';
                if (!isVisible) {
                    document.getElementById('new-codigo').focus();
                }
            ">
        <i class="fas fa-plus me-1"></i> Novo Código ERP
    </button>

    <!-- Formulário para novo -->
    <div id="new-form" class="mt-3" style="display: none;">
        <div class="row g-2">
            <div class="col-md-6">
                <label class="form-label small">Código ERP *</label>
                <input type="text" id="new-codigo" class="form-control form-control-sm" placeholder="Código ERP">
            </div>
            <div class="col-md-6">
                <label class="form-label small">Sistema</label>
                <input type="text" id="new-sistema" class="form-control form-control-sm" placeholder="Sistema">
            </div>
        </div>
        <div class="row g-2 mt-1">
            <div class="col-12">
                <label class="form-label small">Nome *</label>
                <input type="text" id="new-nome" class="form-control form-control-sm" placeholder="Nome/Descrição">
            </div>
        </div>
        <div class="row g-2 mt-1">
            <div class="col-md-6">
                <label class="form-label small">Responsável</label>
                <select id="new-responsavel" class="form-select form-select-sm">
                    <option value="">---------</option>
                    {% for grupo in grupos_cc %}
                    <option value="{{ grupo.codigo }}">{{ grupo.codigo }} - {{ grupo.descricao }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-6">
                <label class="form-label small">Beneficiado</label>
                <select id="new-beneficiado" class="form-select form-select-sm">
                    <option value="">---------</option>
                    {% for grupo in grupos_cc %}
                    <option value="{{ grupo.codigo }}">{{ grupo.codigo }} - {{ grupo.descricao }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>
        <div class="row g-2 mt-2">
            <div class="col-12">
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="new-ativo" checked>
                    <label class="form-check-label small" for="new-ativo">
                        Código ativo
                    </label>
                </div>
            </div>
        </div>
        <div class="mt-2">
            <button type="button" class="btn btn-sm btn-success"
                    onclick="
                        const codigo = document.getElementById('new-codigo').value.trim();
                        const nome = document.getElementById('new-nome').value.trim();
                        const sistema = document.getElementById('new-sistema').value.trim();
                        const responsavel = document.getElementById('new-responsavel').value;
                        const beneficiado = document.getElementById('new-beneficiado').value;
                        const ativo = document.getElementById('new-ativo').checked;
                        const errorDiv = document.getElementById('new-error');

                        if (!codigo || !nome) {
                            errorDiv.textContent = 'Código e nome são obrigatórios';
                            errorDiv.style.display = 'block';
                            return;
                        }

                        const formData = new FormData();
                        formData.append('codigo_externo', codigo);
                        formData.append('nome_externo', nome);
                        formData.append('sistema_origem', sistema);
                        formData.append('codigo_responsavel', responsavel);
                        formData.append('codigo_beneficiado', beneficiado);
                        formData.append('centro_custo', '{{ filtros.centro_codigo }}');
                        if (ativo) {
                            formData.append('ativo', 'on');
                        }
                        formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');

                        fetch('{% url "gestor:centrocustoexterno_create" %}', {
                            method: 'POST',
                            headers: {
                                'X-Requested-With': 'XMLHttpRequest'
                            },
                            body: formData
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                // Limpar formulário
                                document.getElementById('new-codigo').value = '';
                                document.getElementById('new-nome').value = '';
                                document.getElementById('new-sistema').value = '';
                                document.getElementById('new-responsavel').value = '';
                                document.getElementById('new-beneficiado').value = '';
                                document.getElementById('new-ativo').checked = true;
                                document.getElementById('new-form').style.display = 'none';
                                errorDiv.style.display = 'none';

                                // Recarregar apenas o conteúdo do modal sem fechar
                                const modalBody = document.getElementById('relatedTableModal_external_codes_cc_body');
                                if (modalBody) {
                                    fetch('/gestor/centros-custo-externos/?centro={{ filtros.centro_codigo }}', {
                                        headers: {
                                            'X-Requested-With': 'XMLHttpRequest',
                                            'X-CSRFToken': '{{ csrf_token }}'
                                        }
                                    })
                                    .then(response => response.text())
                                    .then(html => {
                                        modalBody.innerHTML = html;
                                    });
                                }
                            } else {
                                errorDiv.textContent = data.message || 'Erro ao criar';
                                errorDiv.style.display = 'block';
                            }
                        })
                        .catch(error => {
                            console.error('Erro:', error);
                            errorDiv.textContent = 'Erro de conexão';
                            errorDiv.style.display = 'block';
                        });
                    ">
                Salvar
            </button>
            <button type="button" class="btn btn-sm btn-secondary"
                    onclick="
                        document.getElementById('new-form').style.display = 'none';
                        document.getElementById('new-error').style.display = 'none';
                        document.getElementById('new-codigo').value = '';
                        document.getElementById('new-nome').value = '';
                        document.getElementById('new-sistema').value = '';
                        document.getElementById('new-responsavel').value = '';
                        document.getElementById('new-beneficiado').value = '';
                        document.getElementById('new-ativo').checked = true;
                    ">
                Cancelar
            </button>
        </div>
        <div id="new-error" style="display: none; color: red; margin-top: 8px;"></div>
    </div>
</div>
