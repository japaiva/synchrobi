<!-- Códigos ERP para Centros de Custo -->

<div class="p-3">
    <h6>Códigos ERP - Centros de Custo</h6>

    {% for externo in page_obj %}
    <div class="border p-2 mb-2" id="item-{{ externo.id }}">

        <!-- Visualização -->
        <div id="view-{{ externo.id }}">
            <div class="d-flex justify-content-between">
                <div>
                    <strong>{{ externo.codigo_externo }}</strong> - {{ externo.nome_externo }}
                    {% if externo.sistema_origem %}
                        <span class="badge bg-info text-dark">{{ externo.sistema_origem }}</span>
                    {% endif %}
                </div>
                <div>
                    <button type="button" class="btn btn-sm btn-primary"
                            onclick="
                                document.getElementById('view-{{ externo.id }}').style.display = 'none';
                                document.getElementById('edit-{{ externo.id }}').style.display = 'block';
                            ">
                        Editar
                    </button>
                    <button type="button" class="btn btn-sm btn-danger ms-1"
                            onclick="
                                if (confirm('Excluir código {{ externo.codigo_externo }}?')) {
                                    fetch('{% url "gestor:api_centrocustoexterno_delete" externo.id %}', {
                                        method: 'POST',
                                        headers: {
                                            'X-CSRFToken': '{{ csrf_token }}',
                                            'X-Requested-With': 'XMLHttpRequest'
                                        }
                                    })
                                    .then(response => response.json())
                                    .then(data => {
                                        if (data.success) {
                                            document.getElementById('item-{{ externo.id }}').remove();
                                            alert('Excluído com sucesso!');
                                        } else {
                                            alert('Erro: ' + data.message);
                                        }
                                    })
                                    .catch(error => {
                                        alert('Erro de conexão');
                                        console.error(error);
                                    });
                                }
                            ">
                        Excluir
                    </button>
                </div>
            </div>
        </div>

        <!-- Edição -->
        <div id="edit-{{ externo.id }}" style="display: none;">
            <div class="row g-2">
                <div class="col-4">
                    <input type="text" id="codigo-{{ externo.id }}" class="form-control"
                           value="{{ externo.codigo_externo }}" placeholder="Código ERP">
                </div>
                <div class="col-5">
                    <input type="text" id="nome-{{ externo.id }}" class="form-control"
                           value="{{ externo.nome_externo }}" placeholder="Nome">
                </div>
                <div class="col-3">
                    <input type="text" id="sistema-{{ externo.id }}" class="form-control"
                           value="{{ externo.sistema_origem|default:'' }}" placeholder="Sistema">
                </div>
            </div>
            <div class="mt-2">
                <button type="button" class="btn btn-sm btn-success"
                        onclick="
                            const codigo = document.getElementById('codigo-{{ externo.id }}').value.trim();
                            const nome = document.getElementById('nome-{{ externo.id }}').value.trim();
                            const sistema = document.getElementById('sistema-{{ externo.id }}').value.trim();
                            const errorDiv = document.getElementById('error-{{ externo.id }}');

                            if (!codigo || !nome) {
                                errorDiv.textContent = 'Código e nome são obrigatórios';
                                errorDiv.style.display = 'block';
                                return;
                            }

                            const formData = new FormData();
                            formData.append('codigo_externo', codigo);
                            formData.append('nome_externo', nome);
                            formData.append('sistema_origem', sistema);
                            formData.append('centro_custo', '{{ filtros.centro_codigo }}');
                            formData.append('ativo', 'on');
                            formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');

                            fetch('{% url "gestor:centrocustoexterno_update" externo.id %}', {
                                method: 'POST',
                                headers: {
                                    'X-Requested-With': 'XMLHttpRequest'
                                },
                                body: formData
                            })
                            .then(response => response.json())
                            .then(data => {
                                if (data.success) {
                                    // Recarregar apenas o conteúdo do modal sem fechar
                                    const modalBody = document.getElementById('relatedTableModal_external_codes_cc_body');
                                    if (modalBody) {
                                        fetch('/gestor/centros-custo-externos/?centro={{ filtros.centro_codigo }}', {
                                            headers: {
                                                'X-Requested-With': 'XMLHttpRequest',
                                                'X-CSRFToken': '{{ csrf_token }}'
                                            }
                                        })
                                        .then(response => response.text())
                                        .then(html => {
                                            modalBody.innerHTML = html;
                                        });
                                    }
                                } else {
                                    errorDiv.textContent = data.message || 'Erro ao salvar';
                                    errorDiv.style.display = 'block';
                                }
                            })
                            .catch(error => {
                                console.error('Erro:', error);
                                errorDiv.textContent = 'Erro de conexão';
                                errorDiv.style.display = 'block';
                            });
                        ">
                    Salvar
                </button>
                <button type="button" class="btn btn-sm btn-secondary"
                        onclick="
                            document.getElementById('edit-{{ externo.id }}').style.display = 'none';
                            document.getElementById('view-{{ externo.id }}').style.display = 'block';
                            document.getElementById('error-{{ externo.id }}').style.display = 'none';
                        ">
                    Cancelar
                </button>
            </div>
            <div id="error-{{ externo.id }}" style="display: none; color: red; margin-top: 8px;"></div>
        </div>
    </div>
    {% empty %}
    <div class="text-center py-4 text-muted">
        <i class="fas fa-link mb-2" style="font-size: 2rem;"></i>
        <p>Nenhum código ERP cadastrado para este centro de custo</p>
    </div>
    {% endfor %}
</div>

<!-- Botão para adicionar novo código -->
<div class="p-3 border-top">
    <button type="button" class="btn btn-success btn-sm"
            onclick="
                const form = document.getElementById('new-form');
                const isVisible = form.style.display !== 'none';
                form.style.display = isVisible ? 'none' : 'block';
                if (!isVisible) {
                    document.getElementById('new-codigo').focus();
                }
            ">
        <i class="fas fa-plus me-1"></i> Novo Código ERP
    </button>

    <!-- Formulário para novo -->
    <div id="new-form" class="mt-3" style="display: none;">
        <div class="row g-2">
            <div class="col-4">
                <input type="text" id="new-codigo" class="form-control" placeholder="Código ERP">
            </div>
            <div class="col-5">
                <input type="text" id="new-nome" class="form-control" placeholder="Nome/Descrição">
            </div>
            <div class="col-3">
                <input type="text" id="new-sistema" class="form-control" placeholder="Sistema">
            </div>
        </div>
        <div class="mt-2">
            <button type="button" class="btn btn-sm btn-success"
                    onclick="
                        const codigo = document.getElementById('new-codigo').value.trim();
                        const nome = document.getElementById('new-nome').value.trim();
                        const sistema = document.getElementById('new-sistema').value.trim();
                        const errorDiv = document.getElementById('new-error');

                        if (!codigo || !nome) {
                            errorDiv.textContent = 'Código e nome são obrigatórios';
                            errorDiv.style.display = 'block';
                            return;
                        }

                        const formData = new FormData();
                        formData.append('codigo_externo', codigo);
                        formData.append('nome_externo', nome);
                        formData.append('sistema_origem', sistema);
                        formData.append('centro_custo', '{{ filtros.centro_codigo }}');
                        formData.append('ativo', 'on');
                        formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');

                        fetch('{% url "gestor:centrocustoexterno_create" %}', {
                            method: 'POST',
                            headers: {
                                'X-Requested-With': 'XMLHttpRequest'
                            },
                            body: formData
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                // Limpar formulário
                                document.getElementById('new-codigo').value = '';
                                document.getElementById('new-nome').value = '';
                                document.getElementById('new-sistema').value = '';
                                document.getElementById('new-form').style.display = 'none';
                                errorDiv.style.display = 'none';

                                // Recarregar apenas o conteúdo do modal sem fechar
                                const modalBody = document.getElementById('relatedTableModal_external_codes_cc_body');
                                if (modalBody) {
                                    fetch('/gestor/centros-custo-externos/?centro={{ filtros.centro_codigo }}', {
                                        headers: {
                                            'X-Requested-With': 'XMLHttpRequest',
                                            'X-CSRFToken': '{{ csrf_token }}'
                                        }
                                    })
                                    .then(response => response.text())
                                    .then(html => {
                                        modalBody.innerHTML = html;
                                    });
                                }
                            } else {
                                errorDiv.textContent = data.message || 'Erro ao criar';
                                errorDiv.style.display = 'block';
                            }
                        })
                        .catch(error => {
                            console.error('Erro:', error);
                            errorDiv.textContent = 'Erro de conexão';
                            errorDiv.style.display = 'block';
                        });
                    ">
                Salvar
            </button>
            <button type="button" class="btn btn-sm btn-secondary"
                    onclick="
                        document.getElementById('new-form').style.display = 'none';
                        document.getElementById('new-error').style.display = 'none';
                        document.getElementById('new-codigo').value = '';
                        document.getElementById('new-nome').value = '';
                        document.getElementById('new-sistema').value = '';
                    ">
                Cancelar
            </button>
        </div>
        <div id="new-error" style="display: none; color: red; margin-top: 8px;"></div>
    </div>
</div>
