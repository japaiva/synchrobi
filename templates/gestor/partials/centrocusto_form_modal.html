<!-- gestor/templates/gestor/partials/centrocusto_form_modal.html -->
<form method="post" action="{% if is_create %}{% url 'gestor:centrocusto_create_modal' %}{% else %}{% url 'gestor:centrocusto_update_modal' centrocusto.codigo %}{% endif %}" novalidate>
    {% csrf_token %}

    {% if form.non_field_errors %}
        <div class="alert alert-danger">
            {% for error in form.non_field_errors %}
                <p class="mb-0">{{ error }}</p>
            {% endfor %}
        </div>
    {% endif %}
    
    <!-- Informações do Pai (se existir) -->
    {% if form.pai_info %}
    <div class="alert alert-info mb-4">
        <h6 class="alert-heading mb-2">
            <i class="fas fa-bullseye me-2"></i>Centro de Custo Superior
        </h6>
        <strong>{{ form.pai_info.codigo }}</strong> - {{ form.pai_info.nome }}
        <br>
    </div>
    {% endif %}
    
    <!-- Informações Principais -->
    <div class="card shadow-sm mb-4">
        <div class="card-header bg-light">
            <h6 class="card-title mb-0">
                <i class="fas fa-info-circle me-2"></i>
                Informações Principais
            </h6>
        </div>
        <div class="card-body">
            <div class="row g-3">
                <!-- Primeira linha: Código e Tipo -->
                <div class="col-md-6">
                    <label for="{{ form.codigo.id_for_label }}" class="form-label">
                        Código Hierárquico <span class="text-danger">*</span>
                    </label>
                    {{ form.codigo }}
                    {% if form.codigo.errors %}
                        <div class="invalid-feedback d-block">
                            {% for error in form.codigo.errors %}{{ error }}{% endfor %}
                        </div>
                    {% endif %}
                </div>
                
                <div class="col-md-3">
                    <label for="{{ form.tipo.id_for_label }}" class="form-label">
                        Tipo <span class="text-danger">*</span>
                    </label>
                    {{ form.tipo }}
                    {% if form.tipo.errors %}
                        <div class="invalid-feedback d-block">
                            {% for error in form.tipo.errors %}{{ error }}{% endfor %}
                        </div>
                    {% endif %}
                </div>
                
                <div class="col-md-3">
                    <div class="form-check form-switch mt-4">
                        {{ form.ativo }}
                        <label class="form-check-label" for="{{ form.ativo.id_for_label }}">
                            Centro Ativo
                        </label>
                    </div>
                    {% if form.ativo.errors %}
                        <div class="invalid-feedback d-block">
                            {% for error in form.ativo.errors %}{{ error }}{% endfor %}
                        </div>
                    {% endif %}
                </div>
                
                <!-- Segunda linha: Informação da Hierarquia -->
                <div class="col-md-12">
                    <label class="form-label">Centro de Custo Superior</label>
                    <div class="form-control bg-light" id="centro-pai-info">
                        {% if form.instance.pk and form.instance.pai %}
                            {{ form.instance.pai.codigo }} - {{ form.instance.pai.nome }}
                        {% elif form.instance.pk %}
                            <span class="badge bg-primary">Centro Raiz</span>
                        {% else %}
                            <span class="text-muted">Será determinado pelo código</span>
                        {% endif %}
                    </div>
                </div>
                
                <!-- Terceira linha: Nome -->
                <div class="col-md-12">
                    <label for="{{ form.nome.id_for_label }}" class="form-label">
                        Nome do Centro de Custo <span class="text-danger">*</span>
                    </label>
                    {{ form.nome }}
                    {% if form.nome.errors %}
                        <div class="invalid-feedback d-block">
                            {% for error in form.nome.errors %}{{ error }}{% endfor %}
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Descrição -->
    <div class="card shadow-sm mb-4">
        <div class="card-header bg-light">
            <h6 class="card-title mb-0">
                <i class="fas fa-file-alt me-2"></i>
                Descrição
            </h6>
        </div>
        <div class="card-body">
            <div class="row g-3">
                <div class="col-12">
                    <label for="{{ form.descricao.id_for_label }}" class="form-label">
                        Descrição (opcional)
                    </label>
                    {{ form.descricao }}
                    {% if form.descricao.errors %}
                        <div class="invalid-feedback d-block">
                            {% for error in form.descricao.errors %}{{ error }}{% endfor %}
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    
    <!-- Validação em Tempo Real -->
    <div id="validacao-codigo" class="alert" style="display: none;">
        <div class="d-flex align-items-center">
            <div class="spinner-border spinner-border-sm me-2" role="status" id="loading-validacao" style="display: none;">
                <span class="visually-hidden">Validando...</span>
            </div>
            <div id="resultado-validacao"></div>
        </div>
    </div>
    
    <!-- Botões de ação -->
    <div class="d-flex justify-content-between align-items-center">
        <div>
            {% if not is_create and form.instance.pk %}
            <button type="button" class="btn btn-outline-danger" 
                    onclick="deleteFromModal('{{ form.instance.codigo }}', '{{ form.instance.nome|escapejs }}')">
                <i class="fas fa-trash me-1"></i> Excluir
            </button>
            {% endif %}
        </div>
        <div>
            <button type="button" class="btn btn-outline-secondary me-2" data-bs-dismiss="modal">
                <i class="fas fa-times me-1"></i> Cancelar
            </button>
            <button type="submit" class="btn btn-primary" id="submitBtn">
                <i class="fas fa-save me-1"></i> 
                {% if is_create %}Criar Centro{% else %}Salvar Alterações{% endif %}
            </button>
        </div>
    </div>
</form>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const codigoInput = document.getElementById('{{ form.codigo.id_for_label }}');
    const centroPaiInfo = document.getElementById('centro-pai-info');
    const validacaoDiv = document.getElementById('validacao-codigo');
    const loadingValidacao = document.getElementById('loading-validacao');
    const resultadoValidacao = document.getElementById('resultado-validacao');
    const submitBtn = document.getElementById('submitBtn');
    
    let validacaoTimeout = null;
    let codigoValido = {% if form.instance.pk %}true{% else %}false{% endif %};
    
    function atualizarInfoHierarquia() {
        const codigo = codigoInput.value.trim();
        
        if (!codigo) {
            centroPaiInfo.innerHTML = '<span class="text-muted">Digite o código para ver</span>';
            codigoValido = false;
            atualizarBotaoSubmit();
            return;
        }
        
        // Validação em tempo real
        clearTimeout(validacaoTimeout);
        validacaoTimeout = setTimeout(() => {
            validarCodigo(codigo);
        }, 500);
        
        // Atualização visual imediata
        if (codigo.includes('.')) {
            const partes = codigo.split('.');
            const codigoPai = partes.slice(0, -1).join('.');
            centroPaiInfo.innerHTML = `Código pai: <strong>${codigoPai}</strong>`;
        } else {
            centroPaiInfo.innerHTML = '<span class="badge bg-primary">Centro Raiz</span>';
        }
    }
    
    function validarCodigo(codigo) {
        if (!codigo) return;
        
        console.log('Validando código:', codigo);
        
        // Mostrar loading
        validacaoDiv.style.display = 'block';
        validacaoDiv.className = 'alert alert-info';
        loadingValidacao.style.display = 'inline-block';
        resultadoValidacao.textContent = 'Validando código...';
        
        const centroCodigoAtual = {% if form.instance.pk %}'{{ form.instance.codigo }}'{% else %}null{% endif %};
        let url = `{% url 'gestor:api_validar_codigo_centrocusto' %}?codigo=${encodeURIComponent(codigo)}`;
        if (centroCodigoAtual) {
            url += `&atual=${encodeURIComponent(centroCodigoAtual)}`;
        }
        
        fetch(url)
        .then(response => response.json())
        .then(data => {
            console.log('Resultado da validação:', data);
            loadingValidacao.style.display = 'none';
            
            if (data.valid) {
                validacaoDiv.className = 'alert alert-success';
                let msg = `✓ Código válido (Nível ${data.nivel})`;
                
                if (data.pai) {
                    msg += ` - Pai: ${data.pai.codigo}`;
                    centroPaiInfo.innerHTML = `
                        <strong>${data.pai.codigo}</strong> - ${data.pai.nome}
                        <br><small class="text-muted">${data.pai.tipo_display}</small>
                    `;
                } else {
                    msg += ' - Centro Raiz';
                    centroPaiInfo.innerHTML = '<span class="badge bg-primary">Centro Raiz</span>';
                }
                
                resultadoValidacao.innerHTML = msg;
                codigoInput.classList.remove('is-invalid');
                codigoInput.classList.add('is-valid');
                codigoValido = true;
            } else {
                validacaoDiv.className = 'alert alert-danger';
                resultadoValidacao.innerHTML = `✗ ${data.error}`;
                codigoInput.classList.remove('is-valid');
                codigoInput.classList.add('is-invalid');
                codigoValido = false;
            }
            
            atualizarBotaoSubmit();
        })
        .catch(error => {
            console.error('Erro na validação:', error);
            loadingValidacao.style.display = 'none';
            validacaoDiv.className = 'alert alert-warning';
            resultadoValidacao.textContent = 'Erro ao validar código';
            codigoValido = false;
            atualizarBotaoSubmit();
        });
    }
    
    function atualizarBotaoSubmit() {
        const codigo = codigoInput.value.trim();
        const nome = document.getElementById('{{ form.nome.id_for_label }}').value.trim();
        
        // Desabilitar se código não é válido ou campos obrigatórios estão vazios
        const podeSubmeter = codigoValido && codigo && nome;
        submitBtn.disabled = !podeSubmeter;
        
        if (!podeSubmeter) {
            submitBtn.classList.add('disabled');
        } else {
            submitBtn.classList.remove('disabled');
        }
    }
    
    // Eventos
    codigoInput.addEventListener('input', function() {
        atualizarInfoHierarquia();
        
        // Limpar validações anteriores
        this.classList.remove('is-valid', 'is-invalid');
        validacaoDiv.style.display = 'none';
        codigoValido = false;
        atualizarBotaoSubmit();
    });
    
    // Monitorar campo nome também
    document.getElementById('{{ form.nome.id_for_label }}').addEventListener('input', atualizarBotaoSubmit);
    
    // Inicializar
    atualizarInfoHierarquia();
    atualizarBotaoSubmit();
    
    // Foco no primeiro campo
    codigoInput.focus();
    
    console.log('Modal de centro de custo inicializado');
});

// Função para excluir do modal
function deleteFromModal(codigo, nome) {
    if (!confirm(`Tem certeza que deseja excluir o centro de custo "${nome}"?\n\nEsta ação não pode ser desfeita.`)) {
        return;
    }
    
    // Fechar modal
    const modal = bootstrap.Modal.getInstance(document.getElementById('centroCustoModal'));
    if (modal) {
        modal.hide();
    }
    
    // Chamar função global de exclusão
    deleteCentroCusto(null, codigo, nome);
}
</script>