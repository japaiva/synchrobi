<!-- gestor/templates/gestor/partials/unidade_form_modal.html -->
<form method="post" action="{% if is_create %}{% url 'gestor:unidade_create_modal' %}{% else %}{% url 'gestor:unidade_update_modal' unidade.id %}{% endif %}" novalidate>
    {% csrf_token %}

    {% if form.non_field_errors %}
        <div class="alert alert-danger">
            {% for error in form.non_field_errors %}
                <p class="mb-0">{{ error }}</p>
            {% endfor %}
        </div>
    {% endif %}
    
    <!-- Informações do Pai (se existir) -->
    {% if form.pai_info %}
    <div class="alert alert-info mb-4">
        <h6 class="alert-heading mb-2">
            <i class="fas fa-sitemap me-2"></i>Unidade Superior
        </h6>
        <strong>{{ form.pai_info.codigo }}</strong> - {{ form.pai_info.nome }}
        <br>
    </div>
    {% endif %}
    
    <!-- Informações Principais -->
    <div class="card shadow-sm mb-4">
        <div class="card-header bg-light">
            <h6 class="card-title mb-0">
                <i class="fas fa-info-circle me-2"></i>
                Informações Principais
            </h6>
        </div>
        <div class="card-body">
            <div class="row g-3">
                <!-- Primeira linha: Código, Empresa e Código All Strategy -->
                <div class="col-md-4">
                    <label for="{{ form.codigo.id_for_label }}" class="form-label">
                        Código Hierárquico <span class="text-danger">*</span>
                    </label>
                    {{ form.codigo }}
                    {% if form.codigo.errors %}
                        <div class="text-danger small mt-1">
                            {% for error in form.codigo.errors %}{{ error }}{% endfor %}
                        </div>
                    {% endif %}
                </div>
                
                <div class="col-md-4">
                    <label for="{{ form.empresa.id_for_label }}" class="form-label">
                        Empresa <span class="text-danger">*</span>
                    </label>
                    {{ form.empresa }}
                    {% if form.empresa.errors %}
                        <div class="text-danger small mt-1">
                            {% for error in form.empresa.errors %}{{ error }}{% endfor %}
                        </div>
                    {% endif %}
                </div>
                
                <div class="col-md-4">
                    <label for="{{ form.codigo_allstrategy.id_for_label }}" class="form-label">
                        Código All Strategy
                    </label>
                    {{ form.codigo_allstrategy }}
                    {% if form.codigo_allstrategy.errors %}
                        <div class="text-danger small mt-1">
                            {% for error in form.codigo_allstrategy.errors %}{{ error }}{% endfor %}
                        </div>
                    {% endif %}
                </div>
                
                <!-- Segunda linha: Informação da Hierarquia e Tipo -->
                <div class="col-md-6">
                    <label class="form-label">Unidade Superior</label>
                    <div class="form-control bg-light" id="unidade-pai-info">
                        {% if form.instance.pk and form.instance.pai %}
                            {{ form.instance.pai.codigo }} - {{ form.instance.pai.nome }}
                        {% elif form.instance.pk %}
                            <span class="badge bg-primary">Unidade Raiz</span>
                        {% else %}
                            <span class="text-muted">Será determinada pelo código</span>
                        {% endif %}
                    </div>
                </div>
                
                <div class="col-md-3">
                    <label for="{{ form.tipo.id_for_label }}" class="form-label">
                        Tipo <span class="text-danger">*</span>
                    </label>
                    {{ form.tipo }}
                    {% if form.tipo.errors %}
                        <div class="text-danger small mt-1">
                            {% for error in form.tipo.errors %}{{ error }}{% endfor %}
                        </div>
                    {% endif %}
                </div>
                
                <div class="col-md-3">
                    <div class="form-check form-switch mt-4">
                        {{ form.ativa }}
                        <label class="form-check-label" for="{{ form.ativa.id_for_label }}">
                            Unidade Ativa
                        </label>
                    </div>
                    {% if form.ativa.errors %}
                        <div class="text-danger small mt-1">
                            {% for error in form.ativa.errors %}{{ error }}{% endfor %}
                        </div>
                    {% endif %}
                </div>
                
                <!-- Terceira linha: Nome -->
                <div class="col-md-12">
                    <label for="{{ form.nome.id_for_label }}" class="form-label">
                        Nome da Unidade <span class="text-danger">*</span>
                    </label>
                    {{ form.nome }}
                    {% if form.nome.errors %}
                        <div class="text-danger small mt-1">
                            {% for error in form.nome.errors %}{{ error }}{% endfor %}
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Descrição -->
    <div class="card shadow-sm mb-4">
        <div class="card-header bg-light">
            <h6 class="card-title mb-0">
                <i class="fas fa-file-alt me-2"></i>
                Descrição
            </h6>
        </div>
        <div class="card-body">
            <div class="row g-3">
                <div class="col-12">
                    <label for="{{ form.descricao.id_for_label }}" class="form-label">
                        Descrição (opcional)
                    </label>
                    {{ form.descricao }}
                    {% if form.descricao.errors %}
                        <div class="text-danger small mt-1">
                            {% for error in form.descricao.errors %}{{ error }}{% endfor %}
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    
    <!-- Validação em Tempo Real -->
    <div id="validacao-codigo" class="alert" style="display: none;">
        <div class="d-flex align-items-center">
            <div class="spinner-border spinner-border-sm me-2" role="status" id="loading-validacao" style="display: none;">
                <span class="visually-hidden">Validando...</span>
            </div>
            <div id="resultado-validacao"></div>
        </div>
    </div>
    
    <!-- Botões de ação -->
    <div class="d-flex justify-content-between align-items-center">
        <div>
            {% if not is_create and form.instance.pk %}
            <button type="button" class="btn btn-outline-danger" 
                    onclick="deleteFromModal({{ form.instance.id }}, '{{ form.instance.nome|escapejs }}')">
                <i class="fas fa-trash me-1"></i> Excluir
            </button>
            {% endif %}
        </div>
        <div>
            <button type="button" class="btn btn-outline-secondary me-2" data-bs-dismiss="modal">
                <i class="fas fa-times me-1"></i> Cancelar
            </button>
            <button type="submit" class="btn btn-primary">
                <i class="fas fa-save me-1"></i> 
                {% if is_create %}Criar Unidade{% else %}Salvar Alterações{% endif %}
            </button>
        </div>
    </div>
</form>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const codigoInput = document.getElementById('{{ form.codigo.id_for_label }}');
    const codigoAllStrategyInput = document.getElementById('{{ form.codigo_allstrategy.id_for_label }}');
    const unidadePaiInfo = document.getElementById('unidade-pai-info');
    const validacaoDiv = document.getElementById('validacao-codigo');
    const loadingValidacao = document.getElementById('loading-validacao');
    const resultadoValidacao = document.getElementById('resultado-validacao');
    
    let validacaoTimeout = null;
    
    function atualizarInfoHierarquia() {
        const codigo = codigoInput.value.trim();
        
        if (!codigo) {
            unidadePaiInfo.innerHTML = '<span class="text-muted">Digite o código para ver</span>';
            return;
        }
        
        // Validação em tempo real
        clearTimeout(validacaoTimeout);
        validacaoTimeout = setTimeout(() => {
            validarCodigo(codigo);
        }, 500);
        
        // Atualização visual imediata
        if (codigo.includes('.')) {
            const partes = codigo.split('.');
            const codigoPai = partes.slice(0, -1).join('.');
            unidadePaiInfo.innerHTML = `Código pai: <strong>${codigoPai}</strong>`;
        } else {
            unidadePaiInfo.innerHTML = '<span class="badge bg-primary">Unidade Raiz</span>';
        }
    }
    
    function validarCodigo(codigo) {
        if (!codigo) return;
        
        // Mostrar loading
        validacaoDiv.style.display = 'block';
        validacaoDiv.className = 'alert alert-info';
        loadingValidacao.style.display = 'inline-block';
        resultadoValidacao.textContent = 'Validando código...';
        
        const unidadeId = {% if form.instance.pk %}{{ form.instance.pk }}{% else %}null{% endif %};
        let url = `{{ CONFIG.apiValidarCodigoUrl }}?codigo=${encodeURIComponent(codigo)}`;
        if (unidadeId) {
            url += `&id=${unidadeId}`;
        }
        
        fetch(url)
        .then(response => response.json())
        .then(data => {
            loadingValidacao.style.display = 'none';
            
            if (data.valid) {
                validacaoDiv.className = 'alert alert-success';
                let msg = `✓ Código válido (Nível ${data.nivel})`;
                
                if (data.pai) {
                    msg += ` - Pai: ${data.pai.codigo}`;
                    unidadePaiInfo.innerHTML = `
                        <strong>${data.pai.codigo}</strong> - ${data.pai.nome}
                        <br><small class="text-muted">${data.pai.tipo_display}</small>
                    `;
                } else {
                    msg += ' - Unidade Raiz';
                    unidadePaiInfo.innerHTML = '<span class="badge bg-primary">Unidade Raiz</span>';
                }
                
                resultadoValidacao.innerHTML = msg;
                codigoInput.classList.remove('is-invalid');
                codigoInput.classList.add('is-valid');
            } else {
                validacaoDiv.className = 'alert alert-danger';
                resultadoValidacao.innerHTML = `✗ ${data.error}`;
                codigoInput.classList.remove('is-valid');
                codigoInput.classList.add('is-invalid');
            }
        })
        .catch(error => {
            loadingValidacao.style.display = 'none';
            validacaoDiv.className = 'alert alert-warning';
            resultadoValidacao.textContent = 'Erro ao validar código';
            console.error('Erro na validação:', error);
        });
    }
    
    function sugerirCodigoAllStrategy() {
        const codigo = codigoInput.value.trim();
        
        if (codigo && !codigoAllStrategyInput.value) {
            const partes = codigo.split('.');
            const ultimoSegmento = partes[partes.length - 1];
            if (ultimoSegmento && /^\d+$/.test(ultimoSegmento)) {
                codigoAllStrategyInput.placeholder = `Sugestão: ${ultimoSegmento}`;
            }
        }
    }
    
    // Eventos
    codigoInput.addEventListener('input', function() {
        atualizarInfoHierarquia();
        sugerirCodigoAllStrategy();
        
        // Limpar validações anteriores
        this.classList.remove('is-valid', 'is-invalid');
        validacaoDiv.style.display = 'none';
    });
    
    // Inicializar
    atualizarInfoHierarquia();
    
    // Foco no primeiro campo
    codigoInput.focus();
});

// Função para excluir do modal
function deleteFromModal(unidadeId, nome) {
    if (!confirm(`Tem certeza que deseja excluir a unidade "${nome}"?\n\nEsta ação não pode ser desfeita.`)) {
        return;
    }
    
    // Fechar modal
    const modal = bootstrap.Modal.getInstance(document.getElementById('unidadeModal'));
    if (modal) {
        modal.hide();
    }
    
    // Chamar função global de exclusão
    deleteUnidade(null, unidadeId, nome);
}
</script>