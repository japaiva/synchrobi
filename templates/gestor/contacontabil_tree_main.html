{% extends 'gestor/base_gestor.html' %}
{% load static %}

{% block title %}Árvore de Contas Contábeis | SynchroBI{% endblock %}

{% block extra_css %}
{% include 'gestor/partials/tree_styles.html' %}
<style>
    .main-container { padding: 0; }
    .card { border-radius: 0; border: none; margin-bottom: 0; border-bottom: 1px solid #dee2e6; }
    .card:last-child { border-bottom: none; }
    .modal-xl { max-width: 90%; }
    .modal-header { background: linear-gradient(135deg, #20c997 0%, #17a2b8 100%); color: white; border-bottom: none; }
    .modal-header .btn-close { filter: invert(1); }
    .loading-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 9999; align-items: center; justify-content: center; }
    .loading-overlay.show { display: flex; }
    .loading-spinner { background: white; padding: 30px; border-radius: 10px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
    .toast-container { position: fixed; top: 20px; right: 20px; z-index: 1055; }
    .tree-node.analytic { background: linear-gradient(135deg, #d1ecf1 0%, #ffffff 100%); border-left-color: #17a2b8 !important; }
    .tree-node.synthetic { background: linear-gradient(135deg, #d4edda 0%, #ffffff 100%); border-left-color: #20c997 !important; }
</style>
{% endblock %}

{% block content %}
<div class="main-container">
    <!-- Header -->
    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h4 class="mb-0">
                <i class="fas fa-calculator me-2 text-info"></i>
                Contas Contábeis
            </h4>
            <div class="d-flex gap-2">
                <button class="btn btn-outline-info btn-sm" onclick="refreshTree()">
                    <i class="fas fa-sync-alt me-1"></i> Atualizar
                </button>
                <button class="btn btn-success btn-sm" onclick="openCreateModal()">
                    <i class="fas fa-plus me-1"></i> Nova Conta
                </button>
            </div>
        </div>
    </div>

    <!-- Controles -->
    <div class="card">
        <div class="card-body">
            <div class="row g-2">
                <div class="col-md-6">
                    <input type="text" id="tree-search" class="form-control" placeholder="Buscar conta contábil...">
                </div>
                <div class="col-md-3">
                    <select class="form-select" id="levelFilter" onchange="filterTree()">
                        <option value="">Todos os Níveis</option>
                        {% for nivel, count in stats.contas_por_nivel.items %}
                            <option value="{{ nivel }}">Nível {{ nivel }} ({{ count }})</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-3">
                    <select class="form-select" id="typeFilter" onchange="filterTree()">
                        <option value="">Todos os Tipos</option>
                        <option value="S">Sintéticos ({{ stats.tipo_s }})</option>
                        <option value="A">Analíticos ({{ stats.tipo_a }})</option>
                    </select>
                </div>
            </div>
        </div>
    </div>

    <!-- Árvore -->
    <div class="card">
        <div class="card-body p-0">
            <ul id="itemTree" class="tree-item"></ul>
        </div>
    </div>
</div>

<!-- Modal -->
<div class="modal fade" id="contaContabilModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalTitle">Carregando...</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="modalBody">
                <div class="text-center py-4">
                    <div class="spinner-border text-primary mb-3"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Loading -->
<div class="loading-overlay" id="loadingOverlay">
    <div class="loading-spinner">
        <div class="spinner-border text-primary mb-3"></div>
        <div>Processando...</div>
    </div>
</div>

<!-- Toasts -->
<div class="toast-container" id="toastContainer"></div>

<!-- Token CSRF -->
{% csrf_token %}
{% endblock %}

{% block extra_js %}
<script>

// JavaScript COMPLETO para contacontabil_tree_main.html

const CONFIG = {
    treeData: {{ tree_data_json|safe }},
    updateUrlBase: '{{ update_url_base }}',
    createUrl: '{% url "gestor:contacontabil_create_modal" %}',
    apiTreeDataUrl: '{% url "gestor:api_contacontabil_tree_data" %}',
    csrfToken: document.querySelector('[name=csrfmiddlewaretoken]').value
};

let filteredData = CONFIG.treeData;
let expandedNodes = new Set();
let modal;
let renderTimeout = null;

document.addEventListener('DOMContentLoaded', () => {
    modal = new bootstrap.Modal(document.getElementById('contaContabilModal'));
    renderTreeOptimized(CONFIG.treeData, document.getElementById('itemTree'));
    
    // Search com debounce
    document.getElementById('tree-search').addEventListener('input', debounce(e => {
        filterTree(e.target.value.toLowerCase());
    }, 300));
});

// ===== FUNÇÕES PRINCIPAIS DE MODAL =====

function openCreateModal(event, codigoPai = null) {
    if (event) {
        event.preventDefault();
        event.stopPropagation();
    }
    
    console.log('Abrindo modal de criação. Código pai:', codigoPai);
    
    let url = CONFIG.createUrl;
    if (codigoPai) {
        url += `?codigo_pai=${encodeURIComponent(codigoPai)}`;
    }
    
    loadModalContent('Nova Conta Contábil', url);
}

function openEditModal(event, codigo) {
    if (event) {
        event.preventDefault();
        event.stopPropagation();
    }
    
    console.log('Abrindo modal de edição para código:', codigo);
    
    if (!codigo) {
        console.error('Código não fornecido para edição');
        showToast('Erro: código não fornecido', 'error');
        return;
    }
    
    const url = `${CONFIG.updateUrlBase}${codigo}/editar/`;
    console.log('URL de edição:', url);
    
    loadModalContent('Editar Conta Contábil', url);
}

function loadModalContent(title, url) {
    console.log('Carregando modal:', title, 'URL:', url);
    
    document.getElementById('modalTitle').textContent = title;
    document.getElementById('modalBody').innerHTML = `
        <div class="text-center py-4">
            <div class="spinner-border text-primary mb-3"></div>
            <div>Carregando...</div>
        </div>
    `;
    
    modal.show();
    
    fetch(url, {
        method: 'GET',
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'X-CSRFToken': CONFIG.csrfToken
        }
    })
    .then(response => {
        console.log('Response status:', response.status);
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        return response.text();
    })
    .then(html => {
        console.log('HTML recebido, tamanho:', html.length);
        document.getElementById('modalBody').innerHTML = html;
        setupModalForm();
    })
    .catch(error => {
        console.error('Erro ao carregar modal:', error);
        document.getElementById('modalBody').innerHTML = `
            <div class="alert alert-danger">
                <h6>Erro ao carregar formulário</h6>
                <p>Erro: ${error.message}</p>
                <button class="btn btn-secondary" onclick="modal.hide()">Fechar</button>
            </div>
        `;
    });
}

function setupModalForm() {
    const form = document.querySelector('#contaContabilModal form');
    if (!form) {
        console.error('Formulário não encontrado no modal');
        return;
    }
    
    console.log('Configurando formulário do modal');
    
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        
        console.log('Submit do formulário interceptado');
        
        const formData = new FormData(this);
        const submitBtn = form.querySelector('button[type="submit"]');
        const originalText = submitBtn.innerHTML;
        
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> Salvando...';
        submitBtn.disabled = true;
        
        fetch(this.action, {
            method: 'POST',
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': CONFIG.csrfToken
            },
            body: formData
        })
        .then(response => {
            console.log('Response do submit:', response.status);
            return response.json();
        })
        .then(data => {
            console.log('Dados de resposta:', data);
            
            if (data.success) {
                showToast(data.message, 'success');
                modal.hide();
                refreshTree();
            } else {
                showToast(data.message || 'Erro ao salvar', 'error');
                
                if (data.errors) {
                    showFormErrors(data.errors);
                }
            }
        })
        .catch(error => {
            console.error('Erro no submit:', error);
            showToast('Erro ao salvar: ' + error.message, 'error');
        })
        .finally(() => {
            submitBtn.innerHTML = originalText;
            submitBtn.disabled = false;
        });
    });
}

function showFormErrors(errors) {
    Object.keys(errors).forEach(field => {
        const input = document.querySelector(`[name="${field}"]`);
        if (input) {
            input.classList.add('is-invalid');
            
            const existingFeedback = input.parentNode.querySelector('.invalid-feedback');
            if (existingFeedback) {
                existingFeedback.remove();
            }
            
            const feedback = document.createElement('div');
            feedback.className = 'invalid-feedback';
            feedback.textContent = errors[field].join(', ');
            input.parentNode.appendChild(feedback);
        }
    });
}

// ===== FUNÇÃO DE EXCLUSÃO =====

function deleteContaContabil(event, codigo, nome) {
    if (event) {
        event.preventDefault();
        event.stopPropagation();
    }
    
    if (!confirm(`Tem certeza que deseja excluir a conta contábil "${nome}"?\n\nEsta ação não pode ser desfeita.`)) {
        return;
    }
    
    console.log('Excluindo conta contábil:', codigo);
    
    showLoadingOverlay(true);
    
    fetch(`${CONFIG.updateUrlBase}${codigo}/excluir/`, {
        method: 'POST',
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'X-CSRFToken': CONFIG.csrfToken
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast(data.message, 'success');
            refreshTree();
        } else {
            showToast(data.message || 'Erro ao excluir', 'error');
        }
    })
    .catch(error => {
        console.error('Erro na exclusão:', error);
        showToast('Erro ao excluir: ' + error.message, 'error');
    })
    .finally(() => {
        showLoadingOverlay(false);
    });
}

// ===== UTILITÁRIOS =====

function showToast(message, type = 'info') {
    const toastContainer = document.getElementById('toastContainer');
    const toastId = 'toast-' + Date.now();
    
    const bgClass = {
        'success': 'bg-success',
        'error': 'bg-danger',
        'warning': 'bg-warning',
        'info': 'bg-info'
    }[type] || 'bg-info';
    
    const toastHtml = `
        <div class="toast ${bgClass} text-white" id="${toastId}" role="alert">
            <div class="d-flex">
                <div class="toast-body">
                    ${message}
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
            </div>
        </div>
    `;
    
    toastContainer.insertAdjacentHTML('beforeend', toastHtml);
    
    const toastElement = document.getElementById(toastId);
    const toast = new bootstrap.Toast(toastElement, { delay: 5000 });
    toast.show();
    
    setTimeout(() => {
        if (toastElement && toastElement.parentNode) {
            toastElement.remove();
        }
    }, 6000);
}

function showLoadingOverlay(show) {
    const overlay = document.getElementById('loadingOverlay');
    if (show) {
        overlay.classList.add('show');
    } else {
        overlay.classList.remove('show');
    }
}

function debounce(func, wait) {
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(renderTimeout);
            func(...args);
        };
        clearTimeout(renderTimeout);
        renderTimeout = setTimeout(later, wait);
    };
}

// ===== FUNÇÕES DE RENDERIZAÇÃO DA ÁRVORE =====

function renderTreeOptimized(data, container) {
    if (renderTimeout) {
        clearTimeout(renderTimeout);
    }
    
    if (!data?.length) {
        container.innerHTML = '<li class="tree-item"><div class="alert alert-info text-center">Nenhuma conta contábil encontrada.</div></li>';
        return;
    }
    
    const fragment = document.createDocumentFragment();
    const batchSize = 50;
    let currentIndex = 0;
    
    function renderBatch() {
        const endIndex = Math.min(currentIndex + batchSize, data.length);
        
        for (let i = currentIndex; i < endIndex; i++) {
            const nodeElement = createTreeNodeOptimized(data[i]);
            fragment.appendChild(nodeElement);
        }
        
        currentIndex = endIndex;
        
        if (currentIndex < data.length) {
            requestAnimationFrame(renderBatch);
        } else {
            container.innerHTML = '';
            container.appendChild(fragment);
        }
    }
    
    requestAnimationFrame(renderBatch);
}

function createTreeNodeOptimized(item) {
    const li = document.createElement('li');
    li.className = 'tree-item';
    
    const hasChildren = item.filhos?.length > 0;
    const isExpanded = expandedNodes.has(item.codigo);
    const typeClass = item.tipo === 'A' ? 'analytic' : 'synthetic';
    
    const nodeHTML = createNodeHTML(item, hasChildren, isExpanded, typeClass);
    li.innerHTML = nodeHTML;
    
    if (hasChildren && isExpanded) {
        const childrenUl = li.querySelector('.tree-children');
        if (childrenUl) {
            const childrenFragment = document.createDocumentFragment();
            item.filhos.forEach(filho => {
                childrenFragment.appendChild(createTreeNodeOptimized(filho));
            });
            childrenUl.appendChild(childrenFragment);
        }
    }
    
    return li;
}

function createNodeHTML(item, hasChildren, isExpanded, typeClass) {
    const typeBadge = item.tipo ? 
        `<span class="type-badge ${typeClass}">${item.tipo === 'A' ? 'Analítico' : 'Sintético'}</span>` : '';
    
    return `
        <div class="tree-node level-${item.nivel} ${typeClass}">
            <div class="tree-info">
                <div class="tree-content">
                    ${hasChildren ? 
                        `<button class="tree-toggle ${isExpanded ? 'expanded' : ''}" onclick="toggleNode(event, '${item.codigo}')">
                            <i class="fas fa-chevron-right"></i>
                        </button>` : 
                        '<span style="width: 22px; display: inline-block;"></span>'
                    }
                    <span class="tree-code">${escapeHtml(item.codigo)}</span>
                    <span class="tree-name">${escapeHtml(item.nome)}</span>
                </div>
                <div class="tree-badges">
                    ${typeBadge}
                    <div class="tree-actions">
                        <button class="btn btn-sm btn-outline-primary" onclick="openEditModal(event, '${item.codigo}')" title="Editar">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-success" onclick="openCreateModal(event, '${item.codigo}')" title="Sub-conta">
                            <i class="fas fa-plus"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteContaContabil(event, '${item.codigo}', '${escapeHtml(item.nome)}')" title="Excluir">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
        ${hasChildren ? 
            `<ul class="tree-children ${isExpanded ? 'expanded' : 'collapsed'}"></ul>` : ''
        }
    `;
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// ===== FUNÇÕES DE NAVEGAÇÃO DA ÁRVORE =====

function toggleNode(event, codigo) {
    event.stopPropagation();
    
    const nodeElement = event.target.closest('.tree-item');
    const childrenUl = nodeElement.querySelector('.tree-children');
    const toggleBtn = nodeElement.querySelector('.tree-toggle');
    
    if (expandedNodes.has(codigo)) {
        expandedNodes.delete(codigo);
        if (childrenUl) {
            childrenUl.classList.remove('expanded');
            childrenUl.classList.add('collapsed');
        }
        if (toggleBtn) {
            toggleBtn.classList.remove('expanded');
        }
    } else {
        expandedNodes.add(codigo);
        if (childrenUl) {
            childrenUl.classList.remove('collapsed');
            childrenUl.classList.add('expanded');
            
            if (childrenUl.children.length === 0) {
                const item = findItemByCode(filteredData, codigo);
                if (item && item.filhos) {
                    const fragment = document.createDocumentFragment();
                    item.filhos.forEach(filho => {
                        fragment.appendChild(createTreeNodeOptimized(filho));
                    });
                    childrenUl.appendChild(fragment);
                }
            }
        }
        if (toggleBtn) {
            toggleBtn.classList.add('expanded');
        }
    }
}

function findItemByCode(data, codigo) {
    for (const item of data) {
        if (item.codigo === codigo) {
            return item;
        }
        if (item.filhos) {
            const found = findItemByCode(item.filhos, codigo);
            if (found) return found;
        }
    }
    return null;
}

// ===== FUNÇÃO DE ATUALIZAÇÃO =====

function refreshTree() {
    console.log('Atualizando árvore');
    
    const treeContainer = document.getElementById('itemTree');
    treeContainer.innerHTML = `
        <li class="tree-item">
            <div class="text-center py-4">
                <div class="spinner-border text-primary mb-2"></div>
                <div class="text-muted">Atualizando árvore...</div>
            </div>
        </li>
    `;
    
    fetch(CONFIG.apiTreeDataUrl, {
        headers: {
            'X-CSRFToken': CONFIG.csrfToken
        }
    })
    .then(response => {
        console.log('Response status da atualização:', response.status);
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        console.log('Dados da árvore atualizados:', data);
        if (data.success) {
            CONFIG.treeData = data.tree_data;
            filteredData = data.tree_data;
            renderTreeOptimized(filteredData, treeContainer);
            showToast('Árvore atualizada com sucesso', 'success');
        } else {
            throw new Error(data.message || 'Erro na resposta da API');
        }
    })
    .catch(error => {
        console.error('Erro na atualização:', error);
        treeContainer.innerHTML = `
            <li class="tree-item">
                <div class="alert alert-danger text-center">
                    <i class="fas fa-exclamation-triangle mb-2"></i>
                    <div>Erro ao atualizar árvore: ${error.message}</div>
                    <button class="btn btn-sm btn-outline-danger mt-2" onclick="refreshTree()">
                        <i class="fas fa-retry me-1"></i> Tentar Novamente
                    </button>
                </div>
            </li>
        `;
        showToast('Erro ao atualizar: ' + error.message, 'error');
    });
}

// ===== FUNÇÕES DE FILTRO =====

function filterTree(searchTerm = '') {
    const levelFilter = document.getElementById('levelFilter').value;
    const typeFilter = document.getElementById('typeFilter').value;
    
    if (!searchTerm && !levelFilter && !typeFilter) {
        filteredData = CONFIG.treeData;
    } else {
        filteredData = filterRecursiveOptimized(CONFIG.treeData, searchTerm, levelFilter, typeFilter);
        if (searchTerm) expandRelevantNodes(filteredData);
    }
    
    renderTreeOptimized(filteredData, document.getElementById('itemTree'));
}

function filterRecursiveOptimized(data, searchTerm, levelFilter, typeFilter) {
    const result = [];
    
    for (const item of data) {
        let matches = true;
        
        if (searchTerm) {
            const searchLower = searchTerm.toLowerCase();
            matches = matches && (
                item.codigo.toLowerCase().includes(searchLower) ||
                item.nome.toLowerCase().includes(searchLower) ||
                (item.descricao && item.descricao.toLowerCase().includes(searchLower))
            );
        }
        
        if (levelFilter && matches) {
            matches = item.nivel === parseInt(levelFilter);
        }
        
        if (typeFilter && matches) {
            matches = item.tipo === typeFilter;
        }
        
        let filteredChildren = [];
        if (item.filhos?.length > 0) {
            filteredChildren = filterRecursiveOptimized(item.filhos, searchTerm, levelFilter, typeFilter);
        }
        
        if (matches || filteredChildren.length > 0) {
            result.push({ ...item, filhos: filteredChildren });
        }
    }
    
    return result;
}

function expandRelevantNodes(data) {
    function expandRecursive(items) {
        for (const item of items) {
            if (item.filhos?.length > 0) {
                expandedNodes.add(item.codigo);
                expandRecursive(item.filhos);
            }
        }
    }
    expandRecursive(data);
}

</script>
{% endblock %}