{% extends 'gestor/base_gestor.html' %}
{% load static %}

{% block title %}√Årvore de Unidades | SynchroBI{% endblock %}

{% block extra_css %}
{% include 'gestor/partials/tree_styles.html' %}
{% endblock %}

{% block content %}
<div class="container-fluid">


    <!-- Controles da √°rvore -->
    <div class="row mb-3">
        <div class="col-md-6">
            <div class="search-container">
                <input type="text" id="tree-search" class="form-control search-input" 
                       placeholder="üîç Buscar unidade...">
            </div>
        </div>
        <div class="col-md-6">
            <div class="d-flex gap-2 justify-content-end">
                <a href="{% url 'gestor:unidade_create' %}" 
                   class="btn btn-success btn-sm"
                   target="_blank"
                   rel="noopener noreferrer"
                   title="Nova unidade (nova aba)">
                    <i class="fas fa-plus me-1"></i> Nova Unidade
                </a>
            </div>
        </div>
    </div>

    <!-- √Årvore hier√°rquica -->
    <div class="tree-container" id="tree-container">
        {% if arvore %}
            {% include 'gestor/partials/tree_node_simple.html' with nodes=arvore %}
        {% else %}
            <div class="text-center py-5">
                <i class="fas fa-sitemap fa-3x text-muted mb-3"></i>
                <h5>Nenhuma unidade encontrada</h5>
                <p class="text-muted">Comece criando a primeira unidade organizacional</p>
                <a href="{% url 'gestor:unidade_create' %}" 
                   class="btn btn-primary"
                   target="_blank"
                   rel="noopener noreferrer">
                    <i class="fas fa-plus me-1"></i> Criar primeira unidade
                </a>
            </div>
        {% endif %}
    </div>
</div>

<!-- Tooltip informativo -->
<div class="position-fixed bottom-0 start-0 p-3" style="z-index: 1000;">
    <div class="card shadow-sm" style="max-width: 300px; opacity: 0.9;">
        <div class="card-body p-3">
            <h6 class="card-title mb-2">
                <i class="fas fa-lightbulb text-warning me-1"></i>
                Dica de Uso
            </h6>
            <p class="card-text small mb-2">
                Todas as a√ß√µes (editar, criar, excluir) abrem em <strong>nova aba</strong>. 
                A √°rvore permanece sempre aberta para voc√™ navegar!
            </p>
            <p class="card-text small mb-0">
                <i class="fas fa-keyboard me-1"></i>
                <strong>Atalhos:</strong> Ctrl+F para buscar
            </p>
            <button class="btn-close position-absolute top-0 end-0 m-2" 
                    onclick="this.closest('.card').style.display='none'"
                    style="font-size: 10px;"></button>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    
    // Funcionalidade de busca
    const searchInput = document.getElementById('tree-search');
    if (searchInput) {
        searchInput.addEventListener('input', function() {
            const searchTerm = this.value.toLowerCase();
            filterTree(searchTerm);
        });
    }

    function filterTree(searchTerm) {
        const treeItems = document.querySelectorAll('.tree-item');
        let visibleCount = 0;

        treeItems.forEach(item => {
            const node = item.querySelector('.tree-node');
            const code = node.querySelector('.tree-code')?.textContent.toLowerCase() || '';
            const name = node.querySelector('.tree-name')?.textContent.toLowerCase() || '';
            
            const matches = !searchTerm || 
                           code.includes(searchTerm) || 
                           name.includes(searchTerm);

            if (matches) {
                item.style.display = 'block';
                node.classList.remove('hidden-by-search');
                
                // Expandir caminho at√© n√≥s encontrados se houver busca
                if (searchTerm) {
                    expandPathToNode(item);
                }
                visibleCount++;
            } else {
                item.style.display = 'none';
                node.classList.add('hidden-by-search');
            }
        });

        // Feedback visual da busca
        if (searchTerm) {
            showSearchFeedback(`${visibleCount} unidade(s) encontrada(s)`);
        } else {
            hideSearchFeedback();
        }
    }

    function expandPathToNode(item) {
        let parent = item.parentElement;
        while (parent) {
            if (parent.classList.contains('tree-children') && parent.classList.contains('collapsed')) {
                const toggle = parent.parentElement.querySelector('.tree-toggle');
                if (toggle) {
                    toggle.click();
                }
            }
            parent = parent.parentElement;
        }
    }

    function showSearchFeedback(message) {
        let feedback = document.getElementById('search-feedback');
        if (!feedback) {
            feedback = document.createElement('div');
            feedback.id = 'search-feedback';
            feedback.className = 'alert alert-info mt-2';
            searchInput.parentElement.appendChild(feedback);
        }
        feedback.innerHTML = `<i class="fas fa-search me-1"></i>${message}`;
        feedback.style.display = 'block';
    }

    function hideSearchFeedback() {
        const feedback = document.getElementById('search-feedback');
        if (feedback) {
            feedback.style.display = 'none';
        }
    }

    // Atalhos de teclado
    document.addEventListener('keydown', function(e) {
        // Ctrl + F para busca
        if (e.ctrlKey && e.key === 'f') {
            e.preventDefault();
            searchInput.focus();
        }
        
        // Ctrl + E para expandir tudo
        if (e.ctrlKey && e.key === 'e') {
            e.preventDefault();
            expandAll();
        }
        
        // Ctrl + R para recolher tudo
        if (e.ctrlKey && e.key === 'r') {
            e.preventDefault();
            collapseAll();
        }
        
        // Escape para limpar busca
        if (e.key === 'Escape' && searchInput === document.activeElement) {
            searchInput.value = '';
            filterTree('');
            searchInput.blur();
        }
    });

    // Feedback quando links de nova aba s√£o clicados
    const newTabLinks = document.querySelectorAll('a[target="_blank"]');
    newTabLinks.forEach(link => {
        link.addEventListener('click', function() {
            showTemporaryMessage('Abrindo em nova aba...');
        });
    });

    function showTemporaryMessage(message) {
        const toast = document.createElement('div');
        toast.className = 'position-fixed top-0 end-0 p-3';
        toast.style.zIndex = '1060';
        toast.innerHTML = `
            <div class="alert alert-success alert-dismissible fade show" role="alert">
                <i class="fas fa-external-link-alt me-2"></i>
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        `;
        
        document.body.appendChild(toast);
        
        setTimeout(() => {
            if (toast.parentNode) {
                toast.parentNode.removeChild(toast);
            }
        }, 3000);
    }

    console.log('‚úÖ √Årvore com nova aba carregada e funcionando');
    
    // Ocultar dica ap√≥s 10 segundos
    setTimeout(() => {
        const tip = document.querySelector('.position-fixed .card');
        if (tip) {
            tip.style.opacity = '0.7';
        }
    }, 10000);
});
</script>
{% endblock %}