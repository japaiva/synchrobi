{% extends 'gestor/base_gestor.html' %}
{% load static %}

{% block title %}Árvore de Centros de Custo | SynchroBI{% endblock %}

{% block extra_css %}
{% include 'gestor/partials/tree_styles.html' %}
<style>
    .main-container { padding: 0; }
    .card { border-radius: 0; border: none; margin-bottom: 0; border-bottom: 1px solid #dee2e6; }
    .card:last-child { border-bottom: none; }
    .modal-xl { max-width: 90%; }
    .modal-header { background: linear-gradient(135deg, #ff6b6b 0%, #ffa726 100%); color: white; border-bottom: none; }
    .modal-header .btn-close { filter: invert(1); }
    .loading-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 9999; align-items: center; justify-content: center; }
    .loading-overlay.show { display: flex; }
    .loading-spinner { background: white; padding: 30px; border-radius: 10px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
    .toast-container { position: fixed; top: 20px; right: 20px; z-index: 1055; }
    .tree-node.analytic { background: linear-gradient(135deg, #e8f5e8 0%, #ffffff 100%); border-left-color: #28a745 !important; }
    .tree-node.synthetic { background: linear-gradient(135deg, #fff3cd 0%, #ffffff 100%); border-left-color: #ffc107 !important; }
</style>
{% endblock %}

{% block content %}
<div class="main-container">
    <!-- Header -->
    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h4 class="mb-0">Centros de Custo</h4>
            <div class="d-flex gap-2">
                <button class="btn btn-outline-info btn-sm" onclick="refreshTree()">
                    <i class="fas fa-sync-alt me-1"></i> Atualizar
                </button>
                <button class="btn btn-success btn-sm" onclick="openCreateModal()">
                    <i class="fas fa-plus me-1"></i> Novo Centro
                </button>
            </div>
        </div>
    </div>

    <!-- Controles -->
    <div class="card">
        <div class="card-body">
            <div class="row g-2">
                <div class="col-md-6">
                    <input type="text" id="tree-search" class="form-control" placeholder="Buscar centro de custo...">
                </div>
                <div class="col-md-3">
                    <select class="form-select" id="levelFilter" onchange="filterTree()">
                        <option value="">Todos os Níveis</option>
                        {% for nivel, count in stats.contas_por_nivel.items %}
                            <option value="{{ nivel }}">Nível {{ nivel }} ({{ count }})</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-3">
                    <select class="form-select" id="typeFilter" onchange="filterTree()">
                        <option value="">Todos os Tipos</option>
                        <option value="S">Sintéticos ({{ stats.tipo_s }})</option>
                        <option value="A">Analíticos ({{ stats.tipo_a }})</option>
                    </select>
                </div>
            </div>
        </div>
    </div>

    <!-- Árvore -->
    <div class="card">
        <div class="card-body p-0">
            <ul id="itemTree" class="tree-item"></ul>
        </div>
    </div>
</div>

<!-- Modal -->
<div class="modal fade" id="centroCustoModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalTitle">Carregando...</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="modalBody">
                <div class="text-center py-4">
                    <div class="spinner-border text-primary mb-3"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Loading -->
<div class="loading-overlay" id="loadingOverlay">
    <div class="loading-spinner">
        <div class="spinner-border text-primary mb-3"></div>
        <div>Processando...</div>
    </div>
</div>

<!-- Toasts -->
<div class="toast-container" id="toastContainer"></div>

<!-- Token CSRF -->
{% csrf_token %}
{% endblock %}

{% block extra_js %}
<script>

// JavaScript OTIMIZADO para centrocusto_tree_main.html

const CONFIG = {
    treeData: {{ tree_data_json|safe }},
    updateUrlBase: '{{ update_url_base }}',
    createUrl: '{% url create_url %}',
    apiTreeDataUrl: '{% url "gestor:api_centrocusto_tree_data" %}',
    csrfToken: document.querySelector('[name=csrfmiddlewaretoken]').value
};

let filteredData = CONFIG.treeData;
let expandedNodes = new Set();
let modal;
let renderTimeout = null; // Para debounce

document.addEventListener('DOMContentLoaded', () => {
    modal = new bootstrap.Modal(document.getElementById('centroCustoModal'));
    renderTreeOptimized(CONFIG.treeData, document.getElementById('itemTree'));
    
    // Search com debounce
    document.getElementById('tree-search').addEventListener('input', debounce(e => {
        filterTree(e.target.value.toLowerCase());
    }, 300));
});

// OTIMIZAÇÃO: Debounce para evitar renders excessivos
function debounce(func, wait) {
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(renderTimeout);
            func(...args);
        };
        clearTimeout(renderTimeout);
        renderTimeout = setTimeout(later, wait);
    };
}

// OTIMIZAÇÃO: Render com Document Fragment
function renderTreeOptimized(data, container) {
    // Limpar loading anterior
    if (renderTimeout) {
        clearTimeout(renderTimeout);
    }
    
    if (!data?.length) {
        container.innerHTML = '<li class="tree-item"><div class="alert alert-info text-center">Nenhum centro de custo encontrado.</div></li>';
        return;
    }
    
    // Usar Document Fragment para melhor performance
    const fragment = document.createDocumentFragment();
    
    // Renderizar em lotes para não travar a UI
    const batchSize = 50;
    let currentIndex = 0;
    
    function renderBatch() {
        const endIndex = Math.min(currentIndex + batchSize, data.length);
        
        for (let i = currentIndex; i < endIndex; i++) {
            const nodeElement = createTreeNodeOptimized(data[i]);
            fragment.appendChild(nodeElement);
        }
        
        currentIndex = endIndex;
        
        if (currentIndex < data.length) {
            // Continuar no próximo frame
            requestAnimationFrame(renderBatch);
        } else {
            // Finalizar renderização
            container.innerHTML = '';
            container.appendChild(fragment);
        }
    }
    
    // Iniciar renderização
    requestAnimationFrame(renderBatch);
}

// OTIMIZAÇÃO: Criar nós de forma mais eficiente
function createTreeNodeOptimized(item) {
    const li = document.createElement('li');
    li.className = 'tree-item';
    
    const hasChildren = item.filhos?.length > 0;
    const isExpanded = expandedNodes.has(item.codigo);
    const typeClass = item.tipo === 'A' ? 'analytic' : 'synthetic';
    
    // Usar template string mais simples
    const nodeHTML = createNodeHTML(item, hasChildren, isExpanded, typeClass);
    li.innerHTML = nodeHTML;
    
    // Adicionar filhos se expandido
    if (hasChildren && isExpanded) {
        const childrenUl = li.querySelector('.tree-children');
        if (childrenUl) {
            const childrenFragment = document.createDocumentFragment();
            item.filhos.forEach(filho => {
                childrenFragment.appendChild(createTreeNodeOptimized(filho));
            });
            childrenUl.appendChild(childrenFragment);
        }
    }
    
    return li;
}

function createNodeHTML(item, hasChildren, isExpanded, typeClass) {
    const typeBadge = item.tipo ? 
        `<span class="type-badge ${typeClass}">${item.tipo === 'A' ? 'Analítico' : 'Sintético'}</span>` : '';
    
    return `
        <div class="tree-node level-${item.nivel} ${typeClass}">
            <div class="tree-info">
                <div class="tree-content">
                    ${hasChildren ? 
                        `<button class="tree-toggle ${isExpanded ? 'expanded' : ''}" onclick="toggleNode(event, '${item.codigo}')">
                            <i class="fas fa-chevron-right"></i>
                        </button>` : 
                        '<span style="width: 22px; display: inline-block;"></span>'
                    }
                    <span class="tree-code">${escapeHtml(item.codigo)}</span>
                    <span class="tree-name">${escapeHtml(item.nome)}</span>
                </div>
                <div class="tree-badges">
                    ${typeBadge}
                    <div class="tree-actions">
                        <button class="btn btn-sm btn-outline-primary" onclick="openEditModal(event, '${item.codigo}')" title="Editar">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-success" onclick="openCreateModal(event, '${item.codigo}')" title="Sub-centro">
                            <i class="fas fa-plus"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteCentroCusto(event, '${item.codigo}', '${escapeHtml(item.nome)}')" title="Excluir">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
        ${hasChildren ? 
            `<ul class="tree-children ${isExpanded ? 'expanded' : 'collapsed'}"></ul>` : ''
        }
    `;
}

// OTIMIZAÇÃO: Escape HTML para segurança
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// OTIMIZAÇÃO: Toggle com menos re-render
function toggleNode(event, codigo) {
    event.stopPropagation();
    
    const nodeElement = event.target.closest('.tree-item');
    const childrenUl = nodeElement.querySelector('.tree-children');
    const toggleBtn = nodeElement.querySelector('.tree-toggle');
    
    if (expandedNodes.has(codigo)) {
        // Colapsar
        expandedNodes.delete(codigo);
        if (childrenUl) {
            childrenUl.classList.remove('expanded');
            childrenUl.classList.add('collapsed');
        }
        if (toggleBtn) {
            toggleBtn.classList.remove('expanded');
        }
    } else {
        // Expandir
        expandedNodes.add(codigo);
        if (childrenUl) {
            childrenUl.classList.remove('collapsed');
            childrenUl.classList.add('expanded');
            
            // Renderizar filhos se ainda não foram renderizados
            if (childrenUl.children.length === 0) {
                const item = findItemByCode(filteredData, codigo);
                if (item && item.filhos) {
                    const fragment = document.createDocumentFragment();
                    item.filhos.forEach(filho => {
                        fragment.appendChild(createTreeNodeOptimized(filho));
                    });
                    childrenUl.appendChild(fragment);
                }
            }
        }
        if (toggleBtn) {
            toggleBtn.classList.add('expanded');
        }
    }
}

// OTIMIZAÇÃO: Buscar item sem re-render completo
function findItemByCode(data, codigo) {
    for (const item of data) {
        if (item.codigo === codigo) {
            return item;
        }
        if (item.filhos) {
            const found = findItemByCode(item.filhos, codigo);
            if (found) return found;
        }
    }
    return null;
}

// OTIMIZAÇÃO: Refresh com loading visual
function refreshTree() {
    console.log('Atualizando árvore');
    
    // Mostrar loading local na árvore
    const treeContainer = document.getElementById('itemTree');
    treeContainer.innerHTML = `
        <li class="tree-item">
            <div class="text-center py-4">
                <div class="spinner-border text-primary mb-2"></div>
                <div class="text-muted">Atualizando árvore...</div>
            </div>
        </li>
    `;
    
    fetch(CONFIG.apiTreeDataUrl, {
        headers: {
            'X-CSRFToken': CONFIG.csrfToken
        }
    })
    .then(response => {
        console.log('Response status da atualização:', response.status);
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        console.log('Dados da árvore atualizados:', data);
        if (data.success) {
            CONFIG.treeData = data.tree_data;
            filteredData = data.tree_data;
            renderTreeOptimized(filteredData, treeContainer);
            showToast('Árvore atualizada com sucesso', 'success');
        } else {
            throw new Error(data.message || 'Erro na resposta da API');
        }
    })
    .catch(error => {
        console.error('Erro na atualização:', error);
        treeContainer.innerHTML = `
            <li class="tree-item">
                <div class="alert alert-danger text-center">
                    <i class="fas fa-exclamation-triangle mb-2"></i>
                    <div>Erro ao atualizar árvore: ${error.message}</div>
                    <button class="btn btn-sm btn-outline-danger mt-2" onclick="refreshTree()">
                        <i class="fas fa-retry me-1"></i> Tentar Novamente
                    </button>
                </div>
            </li>
        `;
        showToast('Erro ao atualizar: ' + error.message, 'error');
    });
}

// Manter as outras funções iguais mas otimizar filtros
function filterTree(searchTerm = '') {
    const levelFilter = document.getElementById('levelFilter').value;
    const typeFilter = document.getElementById('typeFilter').value;
    
    if (!searchTerm && !levelFilter && !typeFilter) {
        filteredData = CONFIG.treeData;
    } else {
        filteredData = filterRecursiveOptimized(CONFIG.treeData, searchTerm, levelFilter, typeFilter);
        if (searchTerm) expandRelevantNodes(filteredData);
    }
    
    renderTreeOptimized(filteredData, document.getElementById('itemTree'));
}

// OTIMIZAÇÃO: Filtro mais eficiente
function filterRecursiveOptimized(data, searchTerm, levelFilter, typeFilter) {
    const result = [];
    
    for (const item of data) {
        let matches = true;
        
        // Aplicar filtros de forma mais eficiente
        if (searchTerm) {
            const searchLower = searchTerm.toLowerCase();
            matches = matches && (
                item.codigo.toLowerCase().includes(searchLower) ||
                item.nome.toLowerCase().includes(searchLower) ||
                (item.descricao && item.descricao.toLowerCase().includes(searchLower))
            );
        }
        
        if (levelFilter && matches) {
            matches = item.nivel === parseInt(levelFilter);
        }
        
        if (typeFilter && matches) {
            matches = item.tipo === typeFilter;
        }
        
        // Processar filhos
        let filteredChildren = [];
        if (item.filhos?.length > 0) {
            filteredChildren = filterRecursiveOptimized(item.filhos, searchTerm, levelFilter, typeFilter);
        }
        
        // Incluir se match ou tem filhos que fazem match
        if (matches || filteredChildren.length > 0) {
            result.push({ ...item, filhos: filteredChildren });
        }
    }
    
    return result;
}

// Manter outras funções como estavam...

</script>
{% endblock %}